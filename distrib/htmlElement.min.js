document.ready = function(fn) {
  if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
    fn();
  } else {
    document.addEventListener("DOMContentLoaded", fn);
  }
}


document.getJSON = function(url, onSuccess, onError) {
  var request = new XMLHttpRequest();
  request.open("GET", url, true);
  request.onload = function() {
    if (request.status >= 200 && request.status < 400) {
      if (onSuccess) {
        onSuccess(JSON.parse(request.responseText));
      }
    } else {
      if (onError) {
        onError(request);
      }
    }
  };
  request.send();
}

document.ajax = function(method, url, data, onSuccess, onError) {
  var request = new XMLHttpRequest();
  request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
  request.open(method, url, true);
  request.onload = function() {
    if (request.status >= 200 && request.status < 400) {
      if (onSuccess) {
        onSuccess(request.responseText);
      }
    } else {
      if (onError) {
        onError(request);
      }
    }
  }
  request.send(data);
}


document.getScripts = function(arrScriptsUrl) {
  for (var url of arrScriptsUrl) {
    document.afterBegin(newElement("script", { src: url }));
  }
}

document.getStyles = function(arrStylessUrl, media = "all") {
  for (var url of arrStylessUrl) {
    document.afterBegin(newElement("link", { rel: "stylesheet", type: "text/css", href: url, media: media }));
  }
}
HTMLElement.prototype.addClass = function(className) {
  this.setAttribute("class", (this.getAttribute("class") || "") + " " + className);
  return this;
}

HTMLElement.prototype.removeClass = function(className) {
  var cl = this.getAttribute("class") || "";
  cl = cl.replace(className, "").trim();
  this.setAttribute("class", cl);
  return this;
}

HTMLElement.prototype.toggleClass = function(className) {
  var cl = this.getAttribute("class") || "";
  if (cl === "") { return this.addClass(className); }
  return this.removeClass(className);
}

HTMLElement.prototype.hasClass = function(className) {
  return (this.getAttribute("class") || "").indexOf(className) >= 0;
}

HTMLElement.prototype.css = function(cssProperty, cssValue) {
  var s = this.style;
  if (arguments.length === 1 && typeof cssProperty === "string") {
    return s[cssProperty];
  }
  if (typeof cssProperty === "object") {
    for (var p in cssProperty) {
      s[p] = cssProperty[p];
    }
  } else {
    this.style[cssProperty] = cssValue;
  }
  return this;
}

// HTMLElement.prototype.appendTo = function(html) {
//   if (typeof html !== "string") {
//     console.error("appendTo:", html, " is not a string");
//   }
//   this.insertAdjacentHTML("beforeend", html);
//   return this;
// }

HTMLElement.prototype.beforeBeginHTML = function(html) { return this.insertAdjacentHTML("beforebegin", html); }
HTMLElement.prototype.afterBeginHTML = function(html) { return this.insertAdjacentHTML("afterBegin", html); }
HTMLElement.prototype.beforeEndHTML = function(html) { return this.insertAdjacentHTML("beforeEnd", html); }
HTMLElement.prototype.afterEndHTML = function(html) { return this.insertAdjacentHTML("afterEnd", html); }

HTMLElement.prototype.beforeBegin = function(el) { return this.insertAdjacentElement("beforebegin", el); }
HTMLElement.prototype.afterBegin = function(el) { return this.insertAdjacentElement("afterbegin", el); }
HTMLElement.prototype.beforeEnd = function(el) { return this.insertAdjacentElement("beforeend", el); }
HTMLElement.prototype.afterEnd = function(el) { return this.insertAdjacentElement("afterend", el); }

HTMLElement.prototype.outerHeight = function(withMargin) {
  //return (this.parentElement) ? this.parentElement.clientHeight : 0;
  if (withMargin) {
    var height = this.offsetHeight;
    var style = getComputedStyle(this);
    height += parseInt(style.marginTop, 10) + parseInt(style.marginBottom, 10);
    return height;
  }
  return this.offsetHeight;

}

HTMLElement.prototype.outerWidth = function(withMargin) {
  if (withMargin) {
    var width = this.offsetWidth;
    var style = getComputedStyle(this);
    width += parseInt(style.marginLeft, 10) + parseInt(style.marginRight, 10);
    return width;
  }
  return this.offsetWidth;

  //return (this.parentElement) ? this.parentElement.clientWidth : 0;
}

HTMLElement.prototype.show = function(visible) {
  if (visible) {
    this.css({ "display": "", visibility: "" });
  } else {
    this.style.display = "none";
  }
}

HTMLElement.prototype.isVisible = function() {
  return this.css("display") !== "none";
}

HTMLElement.prototype.toggleVisible = function() {
  this.show(!this.isVisible());
}

HTMLElement.prototype.html = function(st) {
  if (arguments.length === 0) { return this.innerHTML; }
  this.innerHTML = st;
  return this;
}

HTMLElement.prototype.text = function() {
  return this.textContent;
}

HTMLElement.prototype.parent = function() {
  return this.parentNode;
}

HTMLElement.prototype.outerHtml = function(st) {
  if (arguments.length === 1) {
    this.outerHTML = st;
  } else {
    return this.outerHTML;
  }
}

HTMLElement.prototype.attr = function(name, value) {
  if (arguments.length === 2) {
    this.setAttribute(name, value);
  } else {
    return this.getAttribute(name);
  }
}


HTMLElement.prototype.attrs = function(attributes) {
  if (arguments.length === 1) {
    for (var a in attributes) {
      this.attr(a, attributes[a]);
    }
    return this;
  }
  return [];
}

HTMLElement.prototype.offset = function() {
  //return { top: this.offsetLeft, left: this.offsetTop };
  var rect = this.getBoundingClientRect();
  return {
    top: rect.top + document.body.scrollTop,
    left: rect.left + document.body.scrollLeft
  };
}

HTMLElement.prototype.on = function(evtName, fn, useCapture) {
  if (this.addEventListener) {
    // if (this["on" + evtName] !== undefined) {
    //   this["on" + evtName] = fn;
    // } else
    this.addEventListener(evtName, fn, useCapture || false);
    //this[evtName] = fn;
  } else if (this.attachEvent) {
    this.attachEvent("on" + evtName, fn);
  }
}


HTMLElement.prototype.off = function(eventName, eventHandler) {
  if (this.removeEventListener) {
    this.removeEventListener(eventName, eventHandler, false)
  } else if (this.detachEvent) {
    this.detachEvent("on" + eventName, eventHandler)
  }
}
HTMLFormElement.prototype.val = function() {
  var dic = {};
  var formdata = new FormData(this);
  var done = false;
  var iterator = formdata.entries();
  do {
    var prop = iterator.next();
    if (prop.done && !prop.value) {
      done = true;
    } else {
      dic[prop.value[0]] = prop.value[1];
    }

  } while (!done);
  return dic;
}
HTMLTextAreaElement.prototype.insertAtCaret = function(text) {
  text = text || "";
  if (document.selection) {
    // IE
    this.focus();
    var sel = document.selection.createRange();
    sel.text = text;
  } else if (this.selectionStart || this.selectionStart === 0) {
    // Others
    var startPos = this.selectionStart;
    var endPos = this.selectionEnd;
    this.value = this.value.substring(0, startPos) +
      text +
      this.value.substring(endPos, this.value.length);
    this.selectionStart = startPos + text.length;
    this.selectionEnd = startPos + text.length;
  } else {
    this.value += text;
  }
}


// HTMLTextAreaElement.prototype.ml = function(nb) {
//   if (arguments.length === 0) {
//     return this.attr("maxlength");
//   }
//   this.attr("maxlength", nb);
//   let self = this;
//   this.on("keyup", function() {
//     if (self.value.length > nb) {
//       self.value = self.value.slice(0, nb);
//     }
//   });
// }
function newElement(tagName, attributes, htmlContent, events) {
  var tag = document.createElement(tagName);
  if (attributes) {
    tag.attrs(attributes);
  }
  if (htmlContent) {
    tag.html(htmlContent);
  }
  if (events) {
    for (var ev in events) {
      //tag.on(ev, events[ev], false);
      tag.addEventListener(ev, events[ev]);
    }

  }
  return tag;
}

function qs(id) {
  return document.querySelector(id);
}

function qsa(selectors) {
  return document.querySelectorAll(selectors);
}